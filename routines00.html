<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班級自治小黑板</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 設定 Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        retro: {
                            bg: '#f0e6d2', paper: '#fffbf0', ink: '#2c2c2c', red: '#c0392b',
                            blue: '#2980b9', green: '#27ae60', board: '#2d3436', wood: '#8e44ad', line: '#bdc3c7'
                        }
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px rgba(0,0,0,1)',
                        'hard-sm': '2px 2px 0px 0px rgba(0,0,0,1)',
                        'inner-hard': 'inset 2px 2px 0px 0px rgba(0,0,0,0.1)'
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', '"Songti TC"', 'serif'],
                        mono: ['"Courier New"', 'monospace'],
                        sans: ['"Noto Sans TC"', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            background-color: #f0e6d2;
            background-image: linear-gradient(#e5dcc5 1px, transparent 1px), linear-gradient(90deg, #e5dcc5 1px, transparent 1px);
            background-size: 20px 20px; color: #2c2c2c;
        }
        .retro-scrollbar::-webkit-scrollbar { width: 12px; height: 12px; }
        .retro-scrollbar::-webkit-scrollbar-track { background: #e0d0b0; border-left: 2px solid #2c2c2c; }
        .retro-scrollbar::-webkit-scrollbar-thumb { background: #2c2c2c; border: 2px solid #e0d0b0; }
        .polaroid { background: white; padding: 10px 10px 30px 10px; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); transition: box-shadow 0.2s, transform 0.1s; cursor: grab; }
        .polaroid:active { cursor: grabbing; z-index: 50 !important; box-shadow: 10px 10px 20px rgba(0,0,0,0.4); }
        .polaroid:hover { z-index: 40; }
        @keyframes stamp-in { 0% { opacity: 0; transform: scale(1.5) rotate(15deg); } 100% { opacity: 1; transform: scale(1) rotate(-5deg); } }
        .animate-stamp { animation: stamp-in 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .noise-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; opacity: 0.03; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }
        .writing-vertical { writing-mode: vertical-rl; text-orientation: upright; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div class="noise-overlay"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Users, AlertCircle, Settings, RotateCcw, FileSpreadsheet, Star, Heart, 
            Plus, Minus, ChevronLeft, ChevronRight, Check, Edit3, Trash2, 
            Sparkles, Utensils, Award, Eraser, ClipboardList, X, Save, 
            AlignVerticalJustifyStart, AlignHorizontalJustifyStart, AlertTriangle, BookOpen,
            Clock, Calendar, PenTool, ExternalLink, Image as ImageIcon, Paperclip, Upload,
            Maximize, ZoomIn, ZoomOut, UploadCloud, Loader2
        } from 'lucide-react';

        // ===========================================================================
        // 設定區
        // ===========================================================================
        const GAS_DEPLOY_URL = "https://https://script.google.com/macros/s/AKfycbxqVCu5ZhaPu667HbJf7TpdEwjKkCOlDE35w4rKT72OeqXTEjzIhaTRpyALbtnCUNPZ/exec"; 
        const DEFAULT_ZHUYIN_FONT_URL = "https://raw.githubusercontent.com/Kathy594520/-/main/BpmfZihiOnly-R.ttf"; 

        const App = () => {
            const DEFAULT_LATE_TIME = "07:50";
            const [students, setStudents] = useState([]);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [lateThreshold, setLateThreshold] = useState(DEFAULT_LATE_TIME);
            const [classNameTitle, setClassNameTitle] = useState(() => localStorage.getItem('class_title') || "班級自治小黑板");
            const [showSettings, setShowSettings] = useState(false);
            const [showBatchEdit, setShowBatchEdit] = useState(false);
            const [batchInput, setBatchInput] = useState(""); 
            const [isEditingNote, setIsEditingNote] = useState(false);
            const [leftPanelMode, setLeftPanelMode] = useState('students');
            const [scrapbookImages, setScrapbookImages] = useState(() => {
                try {
                    const saved = localStorage.getItem('class_scrapbook_images');
                    let images = saved ? JSON.parse(saved) : [];
                    return images.map(img => ({ ...img, x: img.x ?? Math.random() * 100, y: img.y ?? Math.random() * 100, scale: img.scale ?? 1 }));
                } catch (e) { return []; }
            });
            const customFontUrl = DEFAULT_ZHUYIN_FONT_URL;
            const [interactionState, setInteractionState] = useState({ mode: null, id: null });
            const dragOffset = useRef({ x: 0, y: 0, startX: 0, startY: 0, initialScale: 1 });
            const scrapbookRef = useRef(null);
            const [confirmConfig, setConfirmConfig] = useState({ show: false, title: "", message: "", action: null, type: "danger" });
            const [checkInMode, setCheckInMode] = useState('attendance');
            const [viewMode, setViewMode] = useState('split');
            const [writingMode, setWritingMode] = useState(() => localStorage.getItem('class_note_writing_mode') || 'horizontal');
            const [clockStyleIndex, setClockStyleIndex] = useState(() => parseInt(localStorage.getItem('class_clock_style') || '0', 10));
            const [splitRatio, setSplitRatio] = useState(() => parseFloat(localStorage.getItem('class_split_ratio') || '50'));
            const [notebookFontSize, setNotebookFontSize] = useState(() => parseInt(localStorage.getItem('class_notebook_font_size') || '32', 10));
            const [fontType, setFontType] = useState(() => localStorage.getItem('class_font_type') || 'sans');
            const [notesData, setNotesData] = useState(() => {
                const saved = localStorage.getItem('class_notes_data');
                if (saved) { try { return JSON.parse(saved); } catch (e) { console.error(e); } }
                const todayKey = new Date().toISOString().split('T')[0];
                return { [todayKey]: "\n\n\n\n\n" };
            });
            const [notebookDate, setNotebookDate] = useState(new Date());
            const splitContainerRef = useRef(null);
            const fileInputRef = useRef(null);
            
            // 上傳狀態
            const [isUploading, setIsUploading] = useState(false);

            useEffect(() => {
                if (customFontUrl) {
                    const styleId = 'custom-zhuyin-font-style';
                    let styleTag = document.getElementById(styleId);
                    if (!styleTag) {
                        styleTag = document.createElement('style'); styleTag.id = styleId; document.head.appendChild(styleTag);
                    }
                    styleTag.textContent = `@font-face { font-family: 'ZhuyinCustom'; src: url('${customFontUrl}') format('truetype'); font-display: swap; }`;
                }
            }, [customFontUrl]);

            const getFontFamily = (type) => {
                switch (type) {
                case 'zhuyin': return "'ZhuyinCustom', 'Noto Serif TC', serif";
                case 'kai': return "'標楷體', 'DFKai-SB', 'KaiTi', 'BiauKai', serif";
                case 'rounded': return "'Varela Round', 'M PLUS Rounded 1c', 'Microsoft JhengHei', '微軟正黑體', sans-serif";
                case 'sans': default: return "'Noto Sans TC', sans-serif";
                }
            };
            const currentFontFamily = getFontFamily(fontType);
            const CLOCK_STYLES = [{ id: 'simple', name: '簡約白', text: 'text-retro-ink' }, { id: 'orange', name: '活力橘', text: 'text-retro-red' }, { id: 'blue', name: '天空藍', text: 'text-retro-blue' }, { id: 'purple', name: '優雅紫', text: 'text-retro-wood' }, { id: 'dark', name: '科技黑', text: 'text-retro-green' }];
            const currentClockStyle = CLOCK_STYLES[clockStyleIndex % CLOCK_STYLES.length];

            useEffect(() => {
                const savedStudents = localStorage.getItem('class_students_v2'); 
                if (savedStudents) { try { const parsed = JSON.parse(savedStudents); if (Array.isArray(parsed)) { const uniqueStudents = Array.from(new Map(parsed.map(item => [item.id, item])).values()); uniqueStudents.sort((a, b) => a.id - b.id); setStudents(uniqueStudents); } } catch(e) { setStudents([]); } } else { setStudents([]); }
            }, []);

            useEffect(() => { localStorage.setItem('class_students_v2', JSON.stringify(students)); }, [students]);
            useEffect(() => { localStorage.setItem('class_title', classNameTitle); }, [classNameTitle]);
            useEffect(() => { localStorage.setItem('class_notes_data', JSON.stringify(notesData)); }, [notesData]);
            useEffect(() => { localStorage.setItem('class_note_writing_mode', writingMode); }, [writingMode]);
            useEffect(() => { localStorage.setItem('class_split_ratio', splitRatio); }, [splitRatio]);
            useEffect(() => { localStorage.setItem('class_notebook_font_size', notebookFontSize); }, [notebookFontSize]);
            useEffect(() => { localStorage.setItem('class_font_type', fontType); }, [fontType]);
            useEffect(() => { localStorage.setItem('class_clock_style', clockStyleIndex); }, [clockStyleIndex]);
            useEffect(() => { try { localStorage.setItem('class_scrapbook_images', JSON.stringify(scrapbookImages)); } catch (e) { console.warn("Storage full"); } }, [scrapbookImages]);

            useEffect(() => {
                const handlePaste = (e) => { if (leftPanelMode !== 'scrapbook') return; const items = e.clipboardData.items; for (let i = 0; i < items.length; i++) { if (items[i].type.indexOf('image') !== -1) { const blob = items[i].getAsFile(); processImageFile(blob); } } };
                window.addEventListener('paste', handlePaste); return () => window.removeEventListener('paste', handlePaste);
            }, [leftPanelMode]);

            useEffect(() => { const timer = setInterval(() => { const now = new Date(); setCurrentTime(now); checkLateStatus(now); }, 1000); return () => clearInterval(timer); }, [lateThreshold]);

            const checkLateStatus = (now) => {
                const [h, m] = lateThreshold.split(':').map(Number);
                const thresholdDate = new Date(now); thresholdDate.setHours(h, m, 0, 0);
                const resetDate = new Date(now); resetDate.setHours(17, 0, 0, 0);
                const isLateAlertPeriod = now >= thresholdDate && now < resetDate;
                setStudents(prev => prev.map(s => { if (s.status === 'idle' && isLateAlertPeriod) return { ...s, status: 'late_absent' }; if (s.status === 'late_absent' && !isLateAlertPeriod) return { ...s, status: 'idle' }; return s; }));
            };

            const handleStudentClick = (id) => {
                setStudents(prev => prev.map(s => {
                    if (s.id !== id) return s;
                    switch (checkInMode) {
                        case 'attendance': {
                            const now = new Date(); const timeString = now.toTimeString().slice(0, 5);
                            const [h, m] = lateThreshold.split(':').map(Number);
                            const thresholdDate = new Date(now); thresholdDate.setHours(h, m, 0, 0);
                            const isLate = now >= thresholdDate;
                            const resetDate = new Date(now); resetDate.setHours(17, 0, 0, 0);
                            const isLateAlertPeriod = now >= thresholdDate && now < resetDate;
                            if (s.status === 'present' || s.status === 'late_arrived') return { ...s, status: isLateAlertPeriod ? 'late_absent' : 'idle', arrivalTime: null };
                            return { ...s, status: isLate ? 'late_arrived' : 'present', arrivalTime: timeString };
                        }
                        case 'brushing': return { ...s, brushing: !s.brushing };
                        case 'lunch': return { ...s, lunch: !s.lunch };
                        case 'duty': return { ...s, isDuty: !s.isDuty };
                        case 'correction': return { ...s, correction: !s.correction }; 
                        default: return s;
                    }
                }));
            };

            const updateStudentData = (originalId, field, value) => {
                setStudents(prev => {
                    const newList = prev.map(s => { if (s.id !== originalId) return s; if (field === 'name') return { ...s, name: value }; if (field === 'id') { const newId = parseInt(value, 10); if (!isNaN(newId) && newId > 0) return { ...s, id: newId }; } return s; });
                    return newList.sort((a, b) => a.id - b.id);
                });
            };
            
            const processImageFile = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    setScrapbookImages(prev => [...prev, { id: Date.now(), src: e.target.result, rotation: Math.random() * 10 - 5, timestamp: new Date().toLocaleString(), x: 20 + Math.random() * 200, y: 20 + Math.random() * 200, scale: 1 }]);
                };
                reader.readAsDataURL(file);
            };

            const handleImageUpload = (e) => { const file = e.target.files[0]; if (file) processImageFile(file); e.target.value = null; };
            const removeImage = (id) => { setScrapbookImages(prev => prev.filter(img => img.id !== id)); };
            const updateImageScale = (id, delta) => { setScrapbookImages(prev => prev.map(img => { if (img.id === id) { return { ...img, scale: Math.max(0.5, Math.min(3.0, (img.scale || 1) + delta)) }; } return img; })); };
            const onMouseDownMove = (e, id, currentX, currentY) => { e.stopPropagation(); if (leftPanelMode !== 'scrapbook') return; dragOffset.current = { x: e.clientX - currentX, y: e.clientY - currentY }; setInteractionState({ mode: 'move', id: id }); };
            const onMouseDownResize = (e, id, currentScale) => { e.stopPropagation(); e.preventDefault(); if (leftPanelMode !== 'scrapbook') return; dragOffset.current = { startX: e.clientX, startY: e.clientY, initialScale: currentScale }; setInteractionState({ mode: 'resize', id: id }); };
            
            const onMouseMoveScrapbook = (e) => {
                if (!interactionState.mode) return;
                if (interactionState.mode === 'move') { setScrapbookImages(prev => prev.map(img => img.id === interactionState.id ? { ...img, x: e.clientX - dragOffset.current.x, y: e.clientY - dragOffset.current.y } : img)); } 
                else if (interactionState.mode === 'resize') { const deltaX = e.clientX - dragOffset.current.startX; setScrapbookImages(prev => prev.map(img => img.id === interactionState.id ? { ...img, scale: Math.max(0.5, Math.min(3.0, dragOffset.current.initialScale + deltaX * 0.005)) } : img)); }
            };
            const onMouseUpScrapbook = () => { setInteractionState({ mode: null, id: null }); };

            const executeConfirmAction = () => { if (confirmConfig.action) { confirmConfig.action(); } setConfirmConfig({ ...confirmConfig, show: false }); };
            const cancelConfirmAction = () => { setConfirmConfig({ ...confirmConfig, show: false }); };
            const confirmRemoveStudent = (e, id) => { e.stopPropagation(); setConfirmConfig({ show: true, title: "移除學生", message: `確定要將座號 ${id} 從名冊中移除嗎？此操作不可逆。`, type: "danger", action: () => { setStudents(prev => prev.filter(s => s.id !== id)); } }); };
            const confirmClearNote = () => { setConfirmConfig({ show: true, title: "黑板擦", message: "確定要擦掉所有板書嗎？", type: "warning", action: () => { updateCurrentNote("\n\n\n\n\n"); } }); };
            
            const confirmResetMode = () => {
                setConfirmConfig({
                    show: true, title: `重置${getModeName(checkInMode)}`, message: `確定要重置所有學生的「${getModeName(checkInMode)}」紀錄嗎？`, type: "warning",
                    action: () => { setStudents(prev => prev.map(s => { switch (checkInMode) { case 'attendance': return { ...s, status: s.status === 'empty' ? 'empty' : 'idle', arrivalTime: null }; case 'brushing': return { ...s, brushing: false }; case 'lunch': return { ...s, lunch: false }; case 'duty': return { ...s, isDuty: false }; case 'correction': return { ...s, correction: false }; default: return s; } })); }
                });
            };

            const openBatchEdit = () => { const textList = students.map(s => `${s.id} ${s.name}`).join('\n'); setBatchInput(textList); setShowBatchEdit(true); };
            const saveBatchEdit = () => {
                const lines = batchInput.split(/\r\n|\n|\r/).filter(line => line.trim() !== '');
                const newStudents = []; const usedIds = new Set();
                lines.forEach(line => { const match = line.trim().match(/^(\d+)[\s,，.]+(.*)$/); if (match) { const id = parseInt(match[1], 10); const name = match[2].trim(); if (!isNaN(id) && id > 0 && name) { if (usedIds.has(id)) { const index = newStudents.findIndex(s => s.id === id); if (index !== -1) newStudents[index].name = name; } else { newStudents.push({ id: id, name: name, status: 'idle', arrivalTime: null, brushing: false, lunch: false, isDuty: false, correction: false }); usedIds.add(id); } } } });
                if (newStudents.length > 0) { newStudents.sort((a, b) => a.id - b.id); setStudents(prev => { const prevMap = new Map(prev.map(s => [s.id, s])); return newStudents.map(newS => { const oldS = prevMap.get(newS.id); if (oldS) return { ...oldS, name: newS.name }; return newS; }); }); setShowBatchEdit(false); } else { alert("名冊格式錯誤"); }
            };
            const addStudent = () => { setStudents(prev => { const maxId = prev.length > 0 ? Math.max(...prev.map(s => s.id)) : 0; return [...prev, { id: maxId + 1, name: "", status: 'idle', arrivalTime: null, brushing: false, lunch: false, isDuty: false, correction: false }].sort((a, b) => a.id - b.id); }); };
            const getModeName = (mode) => { const map = { attendance: '出勤點名', brushing: '潔牙檢查', lunch: '午餐整潔', duty: '值日輪值', correction: '作業訂正' }; return map[mode]; };

            const handleExportCSV = () => {
                const dateStr = currentTime.toLocaleDateString('zh-TW'); let csvContent = "\ufeff日期,座號,姓名,打卡狀態,到校時間,潔牙,午餐整理,值日生,作業訂正\n"; const statusMap = { 'idle': '未到', 'present': '準時', 'late_absent': '遲到未到', 'late_arrived': '遲到已到' };
                [...students].sort((a, b) => a.id - b.id).forEach(s => { csvContent += `${dateStr},${s.id},${s.name},${statusMap[s.status] || '未到'},${s.arrivalTime || '--'},${s.brushing?'V':''},${s.lunch?'V':''},${s.isDuty?'V':''},${s.correction?'V':''}\n`; });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `班級紀錄_${dateStr.replace(/\//g, '-')}.csv`; link.click();
            };

            // -------------------------------------------------------------------------
            // 雲端上傳功能
            // -------------------------------------------------------------------------
            const handleUploadToCloud = async () => {
                if (GAS_DEPLOY_URL === "https://script.google.com/macros/s/AKfycbwpwQu-ANqGKTXJdagOHko55TgmZvRtz7siwlqLaPNR4p8La3f-k9xXlc4ObCZ8c6IV/exec") {
                    alert("請先在程式碼中設定 GAS_DEPLOY_URL！");
                    return;
                }
                
                if (students.length === 0) {
                    alert("名冊是空的，無法上傳！請先新增學生。");
                    return;
                }

                setIsUploading(true);
                const dateStr = currentTime.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
                // 使用 [...students] 建立副本再排序，避免修改原始狀態
                const payload = {
                    date: dateStr,
                    students: [...students].sort((a, b) => a.id - b.id)
                };
                
                console.log("正在準備上傳資料:", payload);

                try {
                    // 使用 no-cors 模式，並且明確指定 charset=utf-8
                    const response = await fetch(GAS_DEPLOY_URL, {
                        method: "POST",
                        mode: "no-cors", 
                        headers: { "Content-Type": "text/plain;charset=utf-8" }, 
                        body: JSON.stringify(payload)
                    });

                    alert("資料已傳送至雲端試算表！\n(由於安全限制，瀏覽器無法確認是否成功，請直接檢查試算表。\n若試算表仍為空白，請檢查 GAS 後端的【執行項目】紀錄。)");
                } catch (error) {
                    console.error("Upload failed", error);
                    alert("上傳失敗，請檢查網路或 GAS 設定。");
                } finally {
                    setIsUploading(false);
                }
            };

            const getNoteDateKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const currentNoteKey = getNoteDateKey(notebookDate);
            const currentNoteContent = notesData[currentNoteKey] || ""; 
            const updateCurrentNote = (content) => setNotesData(prev => ({ ...prev, [currentNoteKey]: content }));
            const noteLines = currentNoteContent.split('\n');
            const toggleClockStyle = () => setClockStyleIndex(prev => (prev + 1) % CLOCK_STYLES.length);
            const getGridColsClass = () => { const n = students.length; if (n === 0) return "grid-cols-1"; if (n <= 30) return "grid-cols-5"; if (n <= 42) return "grid-cols-6"; if (n <= 56) return "grid-cols-8"; return "grid-cols-10"; };
            const handleDragStart = (e) => { e.preventDefault(); document.addEventListener('mousemove', handleDragMove); document.addEventListener('mouseup', handleDragEnd); };
            const handleDragMove = (e) => { if (splitContainerRef.current) { const rect = splitContainerRef.current.getBoundingClientRect(); setSplitRatio(Math.max(20, Math.min(((e.clientX - rect.left) / rect.width) * 100, 80))); } };
            const handleDragEnd = () => { document.removeEventListener('mousemove', handleDragMove); document.removeEventListener('mouseup', handleDragEnd); };

            const formatVerticalContent = (text) => {
                if (writingMode !== 'vertical') return text;
                const parts = text.split(/(\d+)/);
                return parts.map((part, index) => {
                    if (/\d+/.test(part)) return <span key={`num-${index}`} style={{ textCombineUpright: 'all', WebkitTextCombine: 'horizontal', margin: '2px 0', fontFamily: '"Noto Sans TC", sans-serif' }}>{part}</span>;
                    if (/[-－–—]/.test(part)) return part.split('').map((char, cIdx) => (['-', '－', '–', '—'].includes(char) ? <span key={`dash-${index}-${cIdx}`} style={{ display: 'inline-block', transform: 'rotate(90deg)', verticalAlign: 'middle', position: 'relative', left: '1px', fontFamily: '"Noto Sans TC", sans-serif' }}>{char}</span> : char));
                    return part;
                });
            };

            return (
                <div className="h-screen flex flex-col overflow-hidden relative selection:bg-retro-red selection:text-white font-serif" onMouseMove={onMouseMoveScrapbook} onMouseUp={onMouseUpScrapbook}>
                <div className="absolute inset-0 pointer-events-none shadow-[inset_0_0_100px_rgba(44,44,44,0.15)] z-40"></div>
                <div className="bg-white border-b-2 border-retro-ink shadow-hard px-4 py-3 flex justify-between items-center z-20 shrink-0 mx-4 mt-4 mb-2">
                    <div className="flex items-center gap-4">
                        <div className="flex items-center gap-3 relative group min-w-[200px]">
                            <div className="absolute inset-0 bg-[#f1c40f] opacity-20 rotate-[-1deg] transform scale-105 -z-10 skew-x-12"></div>
                            <div className="p-1 border-2 border-retro-ink bg-white flex items-center justify-center shrink-0"><Users className="w-5 h-5 text-retro-ink" strokeWidth={2.5} /></div>
                            <input type="text" value={classNameTitle} onChange={(e) => setClassNameTitle(e.target.value)} placeholder="輸入班級..." className="text-2xl font-black text-retro-ink bg-transparent outline-none w-full placeholder-gray-400 font-serif tracking-widest" style={{ fontFamily: '"Noto Serif TC", serif' }} />
                        </div>
                        <div className="flex bg-white border-2 border-retro-ink rounded-sm shadow-sm overflow-hidden ml-2">
                            <button onClick={() => setLeftPanelMode('students')} className={`px-3 py-1 text-xs font-bold font-mono transition-colors flex items-center gap-1 ${leftPanelMode === 'students' ? 'bg-retro-ink text-white' : 'text-retro-ink hover:bg-gray-100'}`}><Users className="w-3 h-3" /> 名冊</button>
                            <div className="w-[1px] bg-retro-ink"></div>
                            <button onClick={() => setLeftPanelMode('scrapbook')} className={`px-3 py-1 text-xs font-bold font-mono transition-colors flex items-center gap-1 ${leftPanelMode === 'scrapbook' ? 'bg-retro-ink text-white' : 'text-retro-ink hover:bg-gray-100'}`}><ImageIcon className="w-3 h-3" /> 剪貼</button>
                        </div>
                    </div>

                    {leftPanelMode === 'students' && (
                        <div className="flex gap-2 overflow-x-auto no-scrollbar mx-4">
                            <ModeButton active={checkInMode === 'attendance'} onClick={() => setCheckInMode('attendance')} icon={<Users className="w-4 h-4" />} label="點名簿" color="border-retro-ink bg-retro-paper" />
                            <ModeButton active={checkInMode === 'brushing'} onClick={() => setCheckInMode('brushing')} icon={<Sparkles className="w-4 h-4" />} label="潔牙卡" color="border-retro-green bg-green-50" />
                            <ModeButton active={checkInMode === 'lunch'} onClick={() => setCheckInMode('lunch')} icon={<Utensils className="w-4 h-4" />} label="午餐值日" color="border-retro-red bg-red-50" />
                            <ModeButton active={checkInMode === 'duty'} onClick={() => setCheckInMode('duty')} icon={<Award className="w-4 h-4" />} label="值日生" color="border-retro-wood bg-purple-50" />
                            <ModeButton active={checkInMode === 'correction'} onClick={() => setCheckInMode('correction')} icon={<BookOpen className="w-4 h-4" />} label="訂正欄" color="border-retro-blue bg-blue-50" />
                        </div>
                    )}
                    {leftPanelMode === 'scrapbook' && ( <div className="flex-1 flex justify-center items-center text-retro-ink/50 font-serif font-bold italic"><span className="bg-white px-4 py-1 border-b-2 border-retro-ink/20">SCRAPBOOK - 支持貼上(Ctrl+V)與拖拉縮放</span></div> )}

                    <div className="flex items-center gap-4 shrink-0">
                        <div className="flex items-center bg-retro-ink p-1 gap-1 border-2 border-retro-ink hidden md:flex">
                        {['split', 'checkin', 'notebook'].map(m => (<button key={m} onClick={() => setViewMode(m)} className={`px-3 py-1 text-xs font-bold font-mono transition-all ${viewMode === m ? 'bg-[#f1c40f] text-retro-ink border border-black shadow-[2px_2px_0_0_white]' : 'text-white hover:text-[#f1c40f]'}`}>{m === 'split' ? '分屏' : m === 'checkin' ? '左屏' : '黑板'}</button>))}
                        </div>
                        <div className="w-0.5 h-8 bg-retro-ink/20 mx-1"></div>
                        <div className="flex items-center gap-2">
                        {/* 新增：上傳雲端按鈕 */}
                        <button 
                            onClick={handleUploadToCloud} 
                            disabled={isUploading}
                            className={`p-2 border-2 shadow-hard-sm transition-transform active:translate-y-[2px] active:shadow-none bg-white ${isUploading ? 'cursor-not-allowed opacity-50' : 'text-retro-blue border-retro-blue hover:bg-blue-50'}`} 
                            title="上傳雲端資料庫"
                        >
                            {isUploading ? <Loader2 className="w-5 h-5 animate-spin" /> : <UploadCloud className="w-5 h-5" />}
                        </button>
                        
                        <ToolButton onClick={() => setShowSettings(!showSettings)} icon={<Settings className="w-5 h-5" />} title="設定" />
                        <ToolButton onClick={handleExportCSV} icon={<FileSpreadsheet className="w-5 h-5" />} title="匯出報表" />
                        <ToolButton onClick={confirmResetMode} icon={<RotateCcw className="w-5 h-5" />} title="重置狀態" danger />
                        </div>
                    </div>
                </div>

                <div className={`fixed inset-y-0 right-0 w-96 bg-retro-paper border-l-4 border-retro-ink transform transition-transform duration-300 z-50 flex flex-col shadow-[-10px_0_20px_rgba(0,0,0,0.1)] ${showSettings ? 'translate-x-0' : 'translate-x-full'}`}>
                    <div className="p-5 border-b-2 border-retro-ink flex justify-between items-center bg-[#e0d0b0]">
                        <h3 className="font-black text-xl text-retro-ink flex items-center gap-2 font-serif"><span className="bg-retro-ink text-white px-2 py-1 text-sm font-mono">CONFIG</span> 系統設定</h3>
                        <button onClick={() => setShowSettings(false)} className="w-8 h-8 flex items-center justify-center border-2 border-retro-ink bg-white hover:bg-retro-red hover:text-white transition-colors">✕</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-8 retro-scrollbar bg-[url('https://www.transparenttextures.com/patterns/lined-paper.png')]">
                        <div className="bg-white p-4 border-2 border-retro-ink shadow-hard relative">
                            <div className="absolute -top-3 left-3 bg-retro-ink text-white px-2 text-xs font-mono">TIME & FONT</div>
                            <div className="mt-2 space-y-4">
                                <div><label className="block text-sm font-bold text-retro-ink mb-1 font-serif">遲到界線</label><input type="time" value={lateThreshold} onChange={(e) => setLateThreshold(e.target.value)} className="w-full px-2 py-2 bg-retro-bg border-b-2 border-retro-ink outline-none font-mono text-lg focus:bg-white transition-colors" /></div>
                                <div><label className="block text-sm font-bold text-retro-ink mb-1 font-serif">黑板字體風格</label><div className="grid grid-cols-2 gap-2">{['sans', 'kai', 'rounded', 'zhuyin'].map(ft => (<button key={ft} onClick={() => setFontType(ft)} className={`py-1 text-xs font-bold border-2 transition-all ${fontType === ft ? 'bg-retro-ink text-white border-retro-ink' : 'bg-white text-retro-ink border-retro-ink hover:bg-gray-100'}`}>{ft === 'sans' ? '黑體' : ft === 'kai' ? '楷體' : ft === 'rounded' ? '圓體' : '注音體'}</button>))}</div></div>
                            </div>
                        </div>
                        <div className="bg-white p-4 border-2 border-retro-ink shadow-hard relative">
                            <div className="absolute -top-3 left-3 bg-retro-red text-white px-2 text-xs font-mono">STUDENTS</div>
                            <div className="mt-2">
                                <div className="flex justify-end gap-2 mb-4">
                                    <button onClick={openBatchEdit} className="text-xs bg-white text-retro-ink border-2 border-retro-ink px-2 py-1 hover:bg-retro-ink hover:text-white transition-colors font-bold shadow-hard-sm">批次貼上</button>
                                    <button onClick={addStudent} className="text-xs bg-retro-ink text-white border-2 border-retro-ink px-2 py-1 hover:bg-gray-800 transition-colors font-bold shadow-hard-sm flex items-center gap-1"><Plus className="w-3 h-3" /> 新增</button>
                                </div>
                                <div className="space-y-2 max-h-[400px] overflow-y-auto retro-scrollbar pr-2">
                                {students.length === 0 ? ( <div className="text-center text-gray-400 py-6 text-sm border-2 border-dashed border-gray-300 font-serif">名冊空白</div> ) : (
                                    students.map((s) => ( <div key={s.id} className="flex items-center gap-2 group"><input type="number" value={s.id} onChange={(e) => updateStudentData(s.id, 'id', e.target.value)} className="w-12 h-8 px-1 text-sm border-b-2 border-gray-300 text-center font-mono font-bold bg-transparent focus:border-retro-ink outline-none" title="座號" /><input type="text" value={s.name} onChange={(e) => updateStudentData(s.id, 'name', e.target.value)} className="flex-1 h-8 px-2 text-sm border-b-2 border-gray-300 focus:border-retro-ink outline-none bg-transparent font-serif" placeholder="姓名" /><button onClick={(e) => confirmRemoveStudent(e, s.id)} className="p-1.5 text-gray-400 hover:text-retro-red transition-colors" title="移除"><Trash2 className="w-4 h-4" /></button></div> ))
                                )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {showBatchEdit && ( <div className="fixed inset-0 z-[60] bg-retro-ink/80 flex items-center justify-center p-4"><div className="bg-[#f39c12] p-1 rounded-sm shadow-2xl w-full max-w-lg transform rotate-1"><div className="bg-retro-paper border-2 border-retro-ink p-1"><div className="border border-retro-ink border-dashed p-4 flex flex-col gap-4"><div className="flex justify-between items-center border-b-2 border-retro-ink pb-2"><h3 className="text-lg font-black text-retro-ink font-serif flex items-center gap-2"><ClipboardList className="w-5 h-5" /> 匯入名單</h3><button onClick={() => setShowBatchEdit(false)}><X className="w-6 h-6 hover:scale-110 transition-transform" /></button></div><div className="bg-white border-2 border-retro-ink p-3 shadow-inner-hard"><p className="text-xs font-mono text-gray-500 mb-2">FORMAT: ID [SPACE] NAME</p><textarea value={batchInput} onChange={(e) => setBatchInput(e.target.value)} className="w-full h-64 outline-none font-mono text-sm resize-none leading-relaxed bg-transparent" placeholder={`1 王小明\n2 陳大文`} /></div><div className="flex justify-end gap-3"><button onClick={() => setShowBatchEdit(false)} className="px-4 py-2 border-2 border-retro-ink text-retro-ink font-bold hover:bg-gray-100 shadow-hard-sm">取消</button><button onClick={saveBatchEdit} className="px-4 py-2 bg-retro-ink text-white border-2 border-retro-ink font-bold hover:bg-black shadow-hard-sm flex items-center gap-2"><Save className="w-4 h-4" /> 寫入</button></div></div></div></div></div> )}

                {confirmConfig.show && ( <div className="fixed inset-0 z-[70] bg-retro-ink/50 backdrop-blur-sm flex items-center justify-center p-4"><div className="bg-[#fff176] border-4 border-retro-ink p-6 w-full max-w-sm shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] relative"><div className="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-retro-ink text-[#fff176] px-3 py-1 font-black font-mono tracking-widest border-2 border-white">WARNING</div><div className="flex flex-col items-center text-center gap-4 mt-2"><AlertTriangle className={`w-12 h-12 ${confirmConfig.type === 'danger' ? 'text-retro-red' : 'text-orange-500'}`} strokeWidth={2} /><h3 className="text-xl font-black font-serif text-retro-ink">{confirmConfig.title}</h3><p className="text-retro-ink font-medium leading-relaxed font-serif">{confirmConfig.message}</p></div><div className="mt-6 flex justify-center gap-4"><button onClick={cancelConfirmAction} className="px-6 py-2 border-2 border-retro-ink font-bold hover:bg-white transition-colors">取消</button><button onClick={executeConfirmAction} className={`px-6 py-2 border-2 border-retro-ink text-white font-bold shadow-hard-sm active:translate-y-1 active:shadow-none transition-all ${confirmConfig.type === 'danger' ? 'bg-retro-red' : 'bg-orange-500'}`}>確認執行</button></div></div></div> )}

                <div ref={splitContainerRef} className="flex-1 flex flex-col lg:flex-row overflow-hidden p-4 gap-4 z-0">
                    <div className={`flex flex-col bg-[#8d6e63] border-4 border-[#5d4037] shadow-2xl relative transition-all duration-300 ${viewMode === 'notebook' ? 'hidden' : ''}`} style={viewMode === 'split' && typeof window !== 'undefined' && window.innerWidth >= 1024 ? { width: `calc(${splitRatio}% - 1rem)`, flex: 'none' } : { flex: 1 }} ref={scrapbookRef}>
                        <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cork-board.png')] opacity-70 pointer-events-none"></div>
                        {leftPanelMode === 'students' && ( <>
                                <div className="flex-none flex flex-col items-center justify-center py-6 border-b-4 border-[#5d4037] shadow-lg bg-[#fcfbf9] relative z-10 cursor-pointer group" onClick={toggleClockStyle}><div className="flex items-baseline gap-2"><span className={`font-mono font-black text-6xl tracking-tighter ${currentClockStyle.text}`} style={{ textShadow: '2px 2px 0px rgba(0,0,0,0.1)' }}>{currentTime.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' })}</span><span className="text-sm font-bold text-gray-400 font-mono animate-pulse">{currentTime.getSeconds()}</span></div><div className="flex items-center justify-center gap-4 mt-2 w-full px-4"><div className="flex items-center gap-2 text-sm font-bold text-retro-ink border border-retro-ink px-3 py-1 bg-white shadow-sm rotate-1"><Clock className="w-4 h-4" /><span className="font-mono">遲到線: {lateThreshold}</span></div><div className={`text-sm font-black px-4 py-1 border-2 border-retro-ink shadow-hard-sm -rotate-1 ${checkInMode === 'attendance' ? 'bg-retro-paper text-retro-ink' : checkInMode === 'brushing' ? 'bg-green-100 text-retro-green' : checkInMode === 'lunch' ? 'bg-orange-100 text-retro-red' : checkInMode === 'correction' ? 'bg-blue-100 text-retro-blue' : 'bg-purple-100 text-purple-700'}`}>{getModeName(checkInMode)}</div></div></div>
                                <div className="flex-1 p-4 overflow-hidden z-10 h-full relative">{students.length === 0 ? ( <div className="flex flex-col items-center justify-center h-full text-[#5d4037]/50 gap-4" onClick={() => setShowSettings(true)}><div className="border-4 border-dashed border-[#5d4037]/30 p-8 rounded-full"><Users className="w-16 h-16" /></div><p className="text-xl font-bold font-serif">尚未建立名冊</p></div> ) : ( <div className={`grid ${getGridColsClass()} gap-3 h-full`} style={{ fontFamily: currentFontFamily, gridAutoRows: 'minmax(0, 1fr)' }}>{students.map((student) => <StudentCard key={student.id} student={student} mode={checkInMode} fontFamily={currentFontFamily} onClick={() => handleStudentClick(student.id)} />)}</div> )}</div>
                            </> )}
                        {leftPanelMode === 'scrapbook' && ( <div className="flex-1 flex flex-col relative z-10 h-full"><div className="flex justify-between items-center px-4 py-2 border-b-4 border-[#5d4037] bg-[#fcfbf9]/80 backdrop-blur-sm shadow-md z-30"><h3 className="font-black text-retro-ink flex items-center gap-2 font-serif"><Paperclip className="w-4 h-4" /> 班級剪貼簿</h3><div className="flex gap-2"><input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" /><button onClick={() => fileInputRef.current.click()} className="flex items-center gap-1 bg-white border-2 border-retro-ink px-2 py-1 text-xs font-bold shadow-hard-sm hover:translate-y-1 hover:shadow-none transition-all"><Upload className="w-3 h-3" /> 上傳照片</button><button onClick={() => setScrapbookImages([])} className="flex items-center gap-1 bg-retro-red text-white border-2 border-retro-ink px-2 py-1 text-xs font-bold shadow-hard-sm hover:translate-y-1 hover:shadow-none transition-all"><Trash2 className="w-3 h-3" /> 清空</button></div></div><div className="flex-1 relative overflow-hidden">{scrapbookImages.length === 0 ? ( <div className="absolute inset-0 flex flex-col items-center justify-center text-[#5d4037]/40 gap-4 pointer-events-none"><div className="w-24 h-24 border-4 border-dashed border-[#5d4037]/30 flex items-center justify-center rounded-lg rotate-3"><ImageIcon className="w-10 h-10" /></div><p className="font-serif text-lg font-bold">這裡空空的...</p><p className="text-sm font-mono">按 Ctrl+V 貼上圖片或點擊上傳</p></div> ) : ( scrapbookImages.map((img) => ( <div key={img.id} className="polaroid absolute group cursor-move" style={{ left: img.x, top: img.y, width: `${200 * (img.scale || 1)}px`, transform: `rotate(${img.rotation}deg)`, zIndex: interactionState.id === img.id ? 100 : 10 }} onMouseDown={(e) => onMouseDownMove(e, img.id, img.x, img.y)}><img src={img.src} alt="scrapbook" className="w-full h-auto grayscale-[20%] contrast-125 sepia-[30%] pointer-events-none select-none" /><div className="mt-2 text-center font-mono text-[10px] text-gray-400 truncate select-none">{img.timestamp}</div><button onClick={(e) => { e.stopPropagation(); removeImage(img.id); }} className="absolute -top-2 -right-2 bg-retro-red text-white w-6 h-6 rounded-full border-2 border-white shadow-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-50 cursor-pointer"><X className="w-3 h-3" /></button><div className="absolute -top-8 right-8 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-50"><button onClick={(e) => { e.stopPropagation(); updateImageScale(img.id, 0.1); }} className="bg-white border-2 border-retro-ink w-6 h-6 flex items-center justify-center shadow-sm hover:bg-gray-100" title="放大"><Plus className="w-3 h-3" /></button><button onClick={(e) => { e.stopPropagation(); updateImageScale(img.id, -0.1); }} className="bg-white border-2 border-retro-ink w-6 h-6 flex items-center justify-center shadow-sm hover:bg-gray-100" title="縮小"><Minus className="w-3 h-3" /></button></div><div className="absolute bottom-0 right-0 w-6 h-6 cursor-nwse-resize z-50 opacity-0 group-hover:opacity-100" onMouseDown={(e) => onMouseDownResize(e, img.id, img.scale || 1)}><div className="absolute bottom-1 right-1 w-0 h-0 border-b-[8px] border-r-[8px] border-l-[8px] border-l-transparent border-t-transparent border-b-retro-red border-r-retro-red rotate-0"></div></div><div className="absolute -top-3 left-1/2 -translate-x-1/2 w-4 h-12 bg-[#f1c40f]/50 rotate-45 backdrop-blur-sm shadow-sm pointer-events-none"></div></div> )) )}</div></div> )}
                    </div>

                    {viewMode === 'split' && ( <div className="hidden lg:flex w-4 cursor-col-resize items-center justify-center z-30 -ml-2 -mr-2 group" onMouseDown={handleDragStart}><div className="w-1.5 h-16 bg-[#5d4037] border border-[#3e2723] rounded-full group-hover:bg-[#8d6e63] transition-colors shadow-lg"></div></div> )}

                    <div className={`flex flex-col relative rounded-sm shadow-2xl overflow-hidden transition-all duration-300 ${viewMode === 'checkin' ? 'hidden' : ''}`} style={viewMode === 'split' && typeof window !== 'undefined' && window.innerWidth >= 1024 ? { width: `calc(${100 - splitRatio}% - 1rem)`, flex: 'none' } : { flex: 1 }}>
                        <div className="absolute inset-0 border-[16px] border-[#3e2723] pointer-events-none z-20 shadow-[inset_0_0_20px_rgba(0,0,0,0.8)]"></div>
                        <div className="absolute inset-0 bg-[#263238] z-0"><div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')] opacity-30"></div><div className="absolute inset-0 bg-gradient-to-br from-white/5 via-transparent to-white/5 pointer-events-none"></div></div>
                        <div className="relative z-10 flex justify-between items-center p-6 text-gray-200 mt-2"><div className="flex items-center gap-3"><div className="bg-red-600/20 p-2 rounded-full border border-red-500/50"><Star className="w-6 h-6 text-red-400 fill-red-400/50 animate-pulse" /></div><h2 className="text-2xl font-black font-serif tracking-widest text-[#eceff1] opacity-90" style={{ textShadow: '1px 1px 2px black' }}>聯絡事項</h2></div><div className="flex items-center gap-4 font-mono text-lg text-[#eceff1]"><button onClick={() => setNotebookDate(d => { const n = new Date(d); n.setDate(n.getDate()-1); return n; })} className="hover:text-white hover:scale-125 transition-transform"><ChevronLeft /></button><span className="border-b-2 border-white/20 px-2">{getNoteDateKey(notebookDate)}</span><button onClick={() => setNotebookDate(d => { const n = new Date(d); n.setDate(n.getDate()+1); return n; })} className="hover:text-white hover:scale-125 transition-transform"><ChevronRight /></button></div></div>
                        <div className="relative z-10 flex justify-end gap-3 px-6 pb-2 mr-4"><div className="flex items-center bg-white/10 rounded-sm border border-white/20"><button onClick={() => setNotebookFontSize(p => Math.max(16, p-2))} className="p-1.5 hover:bg-white/10 text-white"><Minus className="w-4 h-4" /></button><span className="text-xs font-mono w-8 text-center text-white/80">{notebookFontSize}</span><button onClick={() => setNotebookFontSize(p => Math.min(72, p+2))} className="p-1.5 hover:bg-white/10 text-white"><Plus className="w-4 h-4" /></button></div><button onClick={() => setWritingMode(prev => prev === 'horizontal' ? 'vertical' : 'horizontal')} className="p-1.5 text-white/80 hover:text-white border border-white/20 bg-white/5">{writingMode === 'horizontal' ? <AlignVerticalJustifyStart className="w-4 h-4" /> : <AlignHorizontalJustifyStart className="w-4 h-4" />}</button><button onClick={confirmClearNote} className="p-1.5 text-rose-300 hover:text-rose-100 border border-rose-500/30 bg-rose-500/10"><Eraser className="w-4 h-4" /></button><button onClick={() => setIsEditingNote(!isEditingNote)} className={`p-1.5 border transition-all ${isEditingNote ? 'bg-green-600/50 border-green-400 text-green-100' : 'bg-white/5 border-white/20 text-white/80'}`}>{isEditingNote ? <Check className="w-4 h-4" /> : <Edit3 className="w-4 h-4" />}</button></div>
                        <div className="flex-1 p-8 relative overflow-hidden z-10 mb-8 mx-4">
                        {isEditingNote ? ( <textarea value={currentNoteContent} onChange={(e) => updateCurrentNote(e.target.value)} className={`w-full h-full bg-transparent text-white/90 font-serif outline-none resize-none p-4 leading-relaxed tracking-wider border border-white/10 ${writingMode === 'vertical' ? 'writing-vertical' : ''}`} style={{ fontFamily: currentFontFamily, fontSize: fontType === 'zhuyin' ? `${notebookFontSize * 1.5}px` : `${notebookFontSize}px` }} placeholder="今日事項..." /> ) : ( <div className={`w-full h-full content-start gap-x-12 gap-y-4 ${writingMode === 'vertical' ? 'flex flex-col flex-wrap writing-vertical items-start content-start' : 'flex flex-col'}`} style={{ fontFamily: currentFontFamily, fontSize: `${notebookFontSize}px` }}>{noteLines.map((line, idx) => ( <div key={idx} className={`flex ${writingMode === 'vertical' ? 'flex-row items-center gap-2 py-2 min-h-[1em]' : 'flex-row items-baseline gap-3 my-1'} text-white/95 font-medium`} style={{ textShadow: '1px 1px 0px rgba(0,0,0,0.5)' }}><span className={`text-[#f1c40f] font-black font-mono select-none opacity-80 ${writingMode === 'vertical' ? 'mb-2' : ''}`} style={writingMode === 'vertical' ? { writingMode: 'horizontal-tb' } : {}}>{idx + 1}.</span><span className={`whitespace-pre-wrap leading-relaxed tracking-wide ${writingMode === 'vertical' ? 'rotate-0' : ''}`} style={{ fontSize: fontType === 'zhuyin' ? '1.5em' : '1em', lineHeight: fontType === 'zhuyin' ? '1.2' : 'relaxed' }}>{formatVerticalContent(line)}</span></div> ))}</div> )}
                        </div>
                        <div className="absolute bottom-4 left-0 right-0 h-4 bg-transparent z-20 px-12 flex items-end gap-8 opacity-80 pointer-events-none"><div className="w-12 h-2 bg-white rounded-full shadow-sm transform rotate-1"></div><div className="w-8 h-2 bg-red-300 rounded-full shadow-sm transform -rotate-2"></div><div className="w-20 h-4 bg-[#5d4037] ml-auto rounded-sm border-t border-[#8d6e63]"></div></div>
                    </div>
                </div>

                <div className="bg-[#5d4037] py-1 text-center text-[10px] text-[#d7ccc8] font-mono shrink-0 border-t border-[#3e2723] z-50 relative">Classroom routines Created with Google Apps Script & Tailwind CSS</div>
                </div>
            );
        };
        const ModeButton = ({ active, onClick, icon, label, color }) => ( <button onClick={onClick} className={`flex items-center gap-2 px-3 py-1.5 border-2 transition-all shrink-0 font-serif relative overflow-hidden group ${active ? `${color} shadow-hard-sm -translate-y-1` : 'bg-white border-gray-300 text-gray-400 hover:border-retro-ink hover:text-retro-ink'}`}>{active && <div className="absolute -right-2 -top-2 w-6 h-6 bg-white rotate-45 border border-retro-ink"></div>}{icon}<span className="text-sm font-bold tracking-wider">{label}</span></button> );
        const ToolButton = ({ onClick, icon, title, danger }) => ( <button onClick={onClick} className={`p-2 border-2 shadow-hard-sm transition-transform active:translate-y-[2px] active:shadow-none bg-white ${danger ? 'text-retro-red border-retro-red hover:bg-red-50' : 'text-retro-ink border-retro-ink hover:bg-yellow-50'}`} title={title}>{icon}</button> );
        const StudentCard = ({ student, onClick, fontFamily, mode }) => {
            let bgStyle = "bg-[#fffbf0]", borderStyle = "border-gray-300", textStyle = "text-gray-700", stamp = null;
            if (mode === 'attendance') { switch (student.status) { case 'idle': bgStyle = "bg-[#fffbf0]"; borderStyle = "border-gray-300 group-hover:border-retro-ink"; textStyle = "text-retro-ink"; break; case 'present': bgStyle = "bg-[#fffbf0]"; borderStyle = "border-retro-blue"; textStyle = "text-retro-blue"; stamp = ( <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[80%] h-[80%] border-4 border-retro-blue rounded-full opacity-30 animate-stamp flex items-center justify-center"><span className="text-[10px] font-black -rotate-12 bg-white px-1">{student.arrivalTime}</span></div> ); break; case 'late_absent': bgStyle = "bg-red-50"; borderStyle = "border-retro-red border-dashed"; textStyle = "text-retro-red"; stamp = <div className="absolute top-1 right-1 text-retro-red opacity-80 animate-bounce"><AlertCircle size={16} /></div>; break; case 'late_arrived': bgStyle = "bg-orange-50"; borderStyle = "border-retro-red"; textStyle = "text-retro-ink"; stamp = ( <div className="absolute top-1 right-1 border-2 border-retro-red px-1 py-0.5 text-[10px] font-black text-retro-red rotate-12 animate-stamp">LATE {student.arrivalTime}</div> ); break; } } else if (mode === 'brushing' && student.brushing) { bgStyle = "bg-green-50"; borderStyle = "border-retro-green"; textStyle = "text-retro-green"; stamp = <div className="absolute bottom-1 right-1 text-retro-green opacity-50"><Sparkles size={24} /></div>; } else if (mode === 'lunch' && student.lunch) { bgStyle = "bg-orange-50"; borderStyle = "border-orange-400"; textStyle = "text-orange-600"; stamp = <div className="absolute bottom-1 right-1 text-orange-400 opacity-50 rotate-12"><Utensils size={24} /></div>; } else if (mode === 'duty' && student.isDuty) { bgStyle = "bg-purple-50"; borderStyle = "border-purple-400 double-4"; textStyle = "text-purple-700"; stamp = <div className="absolute top-0 right-2 bg-purple-600 text-white text-[10px] px-1 shadow-sm">值日</div>; } else if (mode === 'correction' && student.correction) { bgStyle = "bg-blue-50"; borderStyle = "border-retro-blue"; textStyle = "text-retro-blue"; stamp = <div className="absolute inset-0 border-2 border-retro-blue rounded-full scale-75 opacity-20"></div>; }
            return ( <button onClick={onClick} style={{ containerType: 'size' }} className={`relative w-full h-full min-h-0 flex flex-col items-center justify-center transition-all duration-100 cursor-pointer select-none border-2 p-1 overflow-hidden group shadow-sm active:scale-95 active:shadow-inner ${bgStyle} ${borderStyle} ${textStyle}`}><div className="absolute top-1/2 left-1 w-2 h-2 bg-retro-bg rounded-full shadow-inner opacity-40"></div><div className="absolute top-1/2 right-1 w-2 h-2 bg-retro-bg rounded-full shadow-inner opacity-40"></div>{stamp}<span className="font-bold leading-tight w-full text-center whitespace-nowrap z-10 font-serif" style={{ fontFamily, fontSize: 'clamp(1rem, min(18cqw, 35cqh), 4rem)' }}><span className="mr-[0.3em] font-mono text-[0.7em] align-middle opacity-50">{student.id}</span>{student.name}</span><div className="absolute bottom-2 w-3/4 h-[1px] bg-current opacity-10"></div></button> );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>